upstream nuts-node-grpc {
  server        nuts-node:5555;
}

upstream nuts-node-http-n2n {
  server        nuts-node:8080;
}

upstream nuts-node-http {
  server        nuts-node:1323;
}

upstream nuts-admin-http {
  server        nuts-admin:1303;
}

upstream lspxnuts-proxyserver-http {
  server        lspxnuts-proxyserver:8000;
}


# node-to-node (HTTPS)
server {
    listen       8443 ssl;
    listen  [::]:8443 ssl;
    server_name  n2n.lsp.dev.nuts-services.nl;

    # SSL configuration
    ssl_certificate             /etc/nuts-certs/n2n.lsp.dev.nuts-services.nl-development.pem;
    ssl_certificate_key         /etc/nuts-certs/n2n.lsp.dev.nuts-services.nl-development.key;
    ssl_client_certificate      /etc/nuts-certs/truststore-development.pem;
    ssl_verify_client           on;
    ssl_verify_depth            1;

    # Headers to make stuff more secure, taken from https://help.dreamhost.com/hc/en-us/articles/222784068-The-most-important-steps-to-take-to-make-an-nginx-server-more-secure
    server_tokens off;
    proxy_hide_header X-Powered-By;
    add_header X-Frame-Options SAMEORIGIN;

    location /n2n {
      proxy_pass http://nuts-node-http-n2n;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # for correct IP logging
    }
}

# node-to-node (gRPC)
server {
    listen       5555 ssl http2;
    listen  [::]:5555 ssl http2;
    server_name  n2n.lsp.dev.nuts-services.nl;

    # SSL configuration
    ssl_certificate             /etc/nuts-certs/n2n.lsp.dev.nuts-services.nl-development.pem;
    ssl_certificate_key         /etc/nuts-certs/n2n.lsp.dev.nuts-services.nl-development.key;
    ssl_client_certificate      /etc/nuts-certs/truststore-development.pem;
    ssl_verify_client           on;
    ssl_verify_depth            1;

    # Headers to make stuff more secure, taken from https://help.dreamhost.com/hc/en-us/articles/222784068-The-most-important-steps-to-take-to-make-an-nginx-server-more-secure
    server_tokens off;
    proxy_hide_header X-Powered-By;
    add_header X-Frame-Options SAMEORIGIN;

    location / {
      grpc_pass grpc://nuts-node-grpc;
      grpc_set_header X-CLIENT-CERT $ssl_client_escaped_cert;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # for correct IP logging
    }
}

# public HTTP interfaces
server {
    listen       443 ssl;
    listen  [::]:443 ssl;
    server_name  public.lsp.dev.nuts-services.nl;

    # SSL configuration
    ssl_certificate             /etc/letsencrypt/live/public.lsp.dev.nuts-services.nl/fullchain.pem;
    ssl_certificate_key         /etc/letsencrypt/live/public.lsp.dev.nuts-services.nl/privkey.pem;

    # Headers to make stuff more secure, taken from https://help.dreamhost.com/hc/en-us/articles/222784068-The-most-important-steps-to-take-to-make-an-nginx-server-more-secure
    server_tokens off;
    proxy_hide_header X-Powered-By;
    add_header X-Frame-Options SAMEORIGIN;

    location /public {
      proxy_pass http://nuts-node-http;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # for correct IP logging
    }
    location /notify {
      proxy_pass http://lspxnuts-proxyserver-http;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # for correct IP logging
    }
    location /aorta {
      proxy_pass http://lspxnuts-proxyserver-http;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # for correct IP logging
    }
}

# admin HTTP interfaces
server {
    listen       443 ssl;
    listen  [::]:443 ssl;
    server_name  admin.lsp.dev.nuts-services.nl;

    # SSL configuration
    ssl_certificate             /etc/letsencrypt/live/admin.lsp.dev.nuts-services.nl/fullchain.pem;
    ssl_certificate_key         /etc/letsencrypt/live/admin.lsp.dev.nuts-services.nl/privkey.pem;

    # Headers to make stuff more secure, taken from https://help.dreamhost.com/hc/en-us/articles/222784068-The-most-important-steps-to-take-to-make-an-nginx-server-more-secure
    server_tokens off;
    proxy_hide_header X-Powered-By;
    add_header X-Frame-Options SAMEORIGIN;

    location /status {
      proxy_pass http://nuts-node-http;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # for correct IP logging
    }
    location /internal {
      proxy_pass http://nuts-node-http;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # for correct IP logging
    }
    location /admin {
      rewrite /admin/(.*) /$1  break;
      proxy_pass http://nuts-admin-http;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # for correct IP logging
    }
}

# LSPxNuts Proxy Server (HTTPS)
server {
    listen       60738 ssl;
    listen  [::]:60738 ssl;
    server_name  greenbox.lsp.dev.nuts-services.nl;

    # SSL configuration
    ssl_certificate             /etc/nuts-certs/greenbox.lsp.dev.nuts-services.nl-development.pem;
    ssl_certificate_key         /etc/nuts-certs/greenbox.lsp.dev.nuts-services.nl-development.key;

    # Headers to make stuff more secure, taken from https://help.dreamhost.com/hc/en-us/articles/222784068-The-most-important-steps-to-take-to-make-an-nginx-server-more-secure
    server_tokens off;
    proxy_hide_header X-Powered-By;
    add_header X-Frame-Options SAMEORIGIN;

    location / {
      proxy_pass http://lspxnuts-proxyserver-http;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # for correct IP logging
    }
}